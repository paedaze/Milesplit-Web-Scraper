<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA Milesplit Virtual Meet Simulator</title>
    <link rel="stylesheet" href="../static/main.css">
</head>
<body>
    <div class="app">
        <header class="app__header">
            <div>
                <p class="eyebrow">Virtual Meet</p>
                <h1 class="app__title">GA Milesplit Virtual Meet Simulator</h1>
                <p class="app__subtitle">Search schools, build your lineup, and view simulated results.</p>
            </div>
        </header>
        <main class="dashboard">
            <section class="panel panel--schools" aria-label="School search">
                <div class="panel__header">
                    <h2>Find schools</h2>
                    <p>Search the GA database and add schools to your simulation.</p>
                </div>
                <div class="panel__body">
                    <label class="search-field">
                        <span class="search-field__icon" aria-hidden="true"></span>
                        <input type="search" placeholder="Search schools" aria-label="Search schools" data-role="school-search">
                    </label>
                    <div class="search-results" data-search-wrapper">
                        <p class="search-hint" data-search-hint>Start typing to search for a school.</p>
                        <ul class="school-list" aria-label="Available schools" data-role="search-results"></ul>
                    </div>
                </div>
            </section>
            <section class="panel panel--selected" aria-labelledby="selected-title">
                <div class="panel__header">
                    <h2 id="selected-title">Selected schools</h2>
                    <p>Manage the schools included in your virtual meet.</p>
                </div>
                <div class="panel__body">
                    <p class="selected-hint" data-selected-hint>No schools selected. Choose from the search results.</p>
                    <ul class="selected-list" data-role="selected-schools"></ul>
                </div>
            </section>
            <section class="panel panel--results" aria-label="Event results">
                <div class="panel__header panel__header--row">
                    <div>
                        <h2>Virtual meet</h2>
                        <p>Choose sport, event, and gender to view standings.</p>
                    </div>
                    <button type="button" class="simulate-button" data-role="simulate-button" aria-label="Run simulation">Go</button>
                </div>
                <div class="panel__body panel__body--padded">
                    <div class="panel__filters">
                        <label class="filter dropdown">
                            <span class="filter__label">Sport</span>
                            <div class="dropdown__control">
                                <span class="dropdown__value" data-role="sport-display">Select sport</span>
                                <span class="dropdown__trigger">
                                    <span class="caret" aria-hidden="true">&#9662;</span>
                                    <select class="dropdown__select" aria-label="Select sport" data-role="sport-select"></select>
                                </span>
                            </div>
                        </label>
                        <label class="filter dropdown">
                            <span class="filter__label">Event</span>
                            <div class="dropdown__control">
                                <span class="dropdown__value" data-role="event-display">Select event</span>
                                <span class="dropdown__trigger">
                                    <span class="caret" aria-hidden="true">&#9662;</span>
                                    <select class="dropdown__select" aria-label="Select event" data-role="event-select"></select>
                                </span>
                            </div>
                        </label>
                        <label class="filter dropdown">
                            <span class="filter__label">Gender</span>
                            <div class="dropdown__control">
                                <span class="dropdown__value" data-role="gender-display">Select gender</span>
                                <span class="dropdown__trigger">
                                    <span class="caret" aria-hidden="true">&#9662;</span>
                                    <select class="dropdown__select" aria-label="Select gender" data-role="gender-select"></select>
                                </span>
                            </div>
                        </label>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th scope="col" class="align-center">Place</th>
                                    <th scope="col" class="align-left">Athlete</th>
                                    <th scope="col" class="align-left">School</th>
                                    <th scope="col" class="align-left">Time</th>
                                    <th scope="col" class="align-center">Points</th>
                                </tr>
                            </thead>
                            <tbody data-role="results-body"></tbody>
                        </table>
                    </div>
                    <p class="results-message" data-role="results-message">
                        Select schools, configure filters, then press Go to simulate your meet.
                    </p>
                    <div class="team-results" data-role="team-results" hidden>
                        <div class="team-results__header">
                            <h3>Team scores</h3>
                            <p data-role="team-results-hint">Cross Country scoring summary.</p>
                        </div>
                        <ul class="team-results__list" data-role="team-results-list"></ul>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script>
        (function () {
            const SPORTS = [
                { id: 'CROSS_COUNTRY', label: 'Cross Country', seasonId: 3 },
                { id: 'OUTDOOR_TRACK', label: 'Outdoor Track', seasonId: 2 },
                { id: 'INDOOR_TRACK', label: 'Indoor Track', seasonId: 1 }
            ];

            const EVENTS = [
                { id: 'FIVE_THOUSAND', label: '5000 Meter Run' },
                { id: 'TWO_MILE', label: '2 Mile Run' },
                { id: 'THIRTYTWO_HUNDRED', label: '3200 Meter Run' },
                { id: 'SIXTEEN_HUNDRED', label: '1600 Meter Run' },
                { id: 'FIFTEEN_HUNDRED', label: '1500 Meter Run' },
                { id: 'TWELVE_HUNDRED', label: '1200 Meter Run' },
                { id: 'EIGHT_HUNDRED', label: '800 Meter Run' },
                { id: 'FOUR_HUNDRED', label: '400 Meter Dash' },
                { id: 'TWO_HUNDRED', label: '200 Meter Dash' },
                { id: 'ONE_HUNDRED', label: '100 Meter Dash' }
            ];

            const GENDERS = [
                { id: 'MALE', label: 'Male', value: 'm' },
                { id: 'FEMALE', label: 'Female', value: 'f' }
            ];

            let schoolsMap = {};
            let schoolNames = [];
            const searchInput = document.querySelector('[data-role="school-search"]');
            const resultsList = document.querySelector('[data-role="search-results"]');
            const selectedList = document.querySelector('[data-role="selected-schools"]');
            const searchHint = document.querySelector('[data-search-hint]');
            const selectedHint = document.querySelector('[data-selected-hint]');
            const sportSelect = document.querySelector('[data-role="sport-select"]');
            const eventSelect = document.querySelector('[data-role="event-select"]');
            const genderSelect = document.querySelector('[data-role="gender-select"]');
            const sportDisplay = document.querySelector('[data-role="sport-display"]');
            const eventDisplay = document.querySelector('[data-role="event-display"]');
            const genderDisplay = document.querySelector('[data-role="gender-display"]');
            const resultsBody = document.querySelector('[data-role="results-body"]');
            const resultsMessage = document.querySelector('[data-role="results-message"]');
            const simulateButton = document.querySelector('[data-role="simulate-button"]');
            const teamResults = document.querySelector('[data-role="team-results"]');
            const teamResultsList = document.querySelector('[data-role="team-results-list"]');
            const teamResultsHint = document.querySelector('[data-role="team-results-hint"]');
            const MAX_RESULTS = 12;
            const selected = [];

            const setHint = (el, message, isHidden) => {
                if (!el) {
                    return;
                }
                el.textContent = message;
                el.hidden = !!isHidden;
            };

            const loadSchools = async () => {
                setHint(searchHint, 'Loading schools...', false);
                if (searchInput) {
                    searchInput.disabled = true;
                }
                try {
                    const response = await fetch('/api/schools');
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }
                    schoolsMap = await response.json();
                    schoolNames = Object.keys(schoolsMap).sort((a, b) => a.localeCompare(b));
                    if (searchInput) {
                        searchInput.disabled = false;
                    }
                    setHint(searchHint, 'Start typing to search for a school.', false);
                } catch (error) {
                    console.error('Unable to load school list', error);
                    setHint(
                        searchHint,
                        'Unable to load school list. Refresh the page to try again.',
                        false
                    );
                }
            };

            const renderResults = (names, emptyMessage) => {
                resultsList.innerHTML = '';
                if (!names.length) {
                    setHint(searchHint, emptyMessage || 'No schools match your search.', false);
                    return;
                }
                setHint(searchHint, '', true);
                const frag = document.createDocumentFragment();
                names.forEach((name) => {
                    const li = document.createElement('li');
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'result-option';
                    button.dataset.schoolName = name;
                    button.textContent = name;
                    button.setAttribute('aria-label', `Add ${name} to selected schools`);
                    li.appendChild(button);
                    frag.appendChild(li);
                });
                resultsList.appendChild(frag);
            };

            const renderSelected = () => {
                selectedList.innerHTML = '';
                if (!selected.length) {
                    setHint(selectedHint, 'No schools selected. Choose from the search results.', false);
                    return;
                }
                setHint(selectedHint, '', true);
                const frag = document.createDocumentFragment();
                selected.forEach((name) => {
                    const li = document.createElement('li');
                    li.className = 'selected-pill';
                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = name;
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'pill__remove';
                    removeBtn.dataset.removeSchool = name;
                    removeBtn.setAttribute('aria-label', `Remove ${name}`);
                    removeBtn.textContent = 'x';
                    li.append(labelSpan, removeBtn);
                    frag.appendChild(li);
                });
                selectedList.appendChild(frag);
            };

            const addSchool = (name) => {
                if (!name || selected.includes(name)) {
                    return;
                }
                selected.push(name);
                renderSelected();
            };

            const removeSchool = (name) => {
                const index = selected.indexOf(name);
                if (index === -1) {
                    return;
                }
                selected.splice(index, 1);
                renderSelected();
            };

            const getMatches = (query) => {
                const trimmed = query.trim().toLowerCase();
                if (!trimmed) {
                    return [];
                }
                return schoolNames
                    .filter((name) => name.toLowerCase().includes(trimmed))
                    .slice(0, MAX_RESULTS);
            };

            const populateSelect = (selectEl, items, config = {}) => {
                if (!selectEl) {
                    return;
                }
                const { valueKey = 'id', textKey = 'label' } = config;
                selectEl.innerHTML = '';
                items.forEach((item) => {
                    const option = document.createElement('option');
                    option.value = item[valueKey];
                    option.textContent = item[textKey];
                    if (item.seasonId) {
                        option.dataset.seasonId = item.seasonId;
                    }
                    if (item.label) {
                        option.dataset.label = item.label;
                    }
                    if (Object.prototype.hasOwnProperty.call(item, 'value')) {
                        option.dataset.value = item.value;
                    }
                    selectEl.appendChild(option);
                });
            };

            const safeText = (value) => (value === undefined || value === null ? '' : value);

            const setResultsMessage = (message, options = {}) => {
                if (!resultsMessage) {
                    return;
                }
                const { type } = options;
                const copy = message || '';
                resultsMessage.textContent = copy;
                resultsMessage.hidden = !copy;
                resultsMessage.classList.toggle('results-message--error', type === 'error');
            };

            const renderAthleteRows = (rows = []) => {
                if (!resultsBody) {
                    return;
                }
                resultsBody.innerHTML = '';
                if (!rows.length) {
                    return;
                }
                const fragment = document.createDocumentFragment();
                rows.forEach((row) => {
                    const tr = document.createElement('tr');
                    const cells = [
                        { text: row?.place, className: 'align-center' },
                        { text: row?.athlete, className: 'align-left' },
                        { text: row?.school, className: 'align-left' },
                        { text: row?.time, className: 'align-left' },
                        { text: row?.points, className: 'align-center' }
                    ];
                    cells.forEach((cell) => {
                        const td = document.createElement('td');
                        if (cell.className) {
                            td.className = cell.className;
                        }
                        td.textContent = safeText(cell.text);
                        tr.appendChild(td);
                    });
                    fragment.appendChild(tr);
                });
                resultsBody.appendChild(fragment);
            };

            const renderTeamScores = (teams = [], sport) => {
                if (!teamResults || !teamResultsList || !teamResultsHint) {
                    return;
                }
                if (sport !== 'CROSS_COUNTRY' || !teams.length) {
                    teamResults.hidden = true;
                    teamResultsList.innerHTML = '';
                    teamResultsHint.textContent = 'Team scoring is available for Cross Country meets.';
                    return;
                }
                teamResults.hidden = false;
                teamResultsHint.textContent = 'Top 5 runners score; 6th and 7th runners break ties.';
                teamResultsList.innerHTML = '';
                const fragment = document.createDocumentFragment();
                teams.forEach((team, index) => {
                    const li = document.createElement('li');
                    li.className = 'team-results__item';
                    const placeLabel =
                        team?.eligible && team?.score !== null && team?.score !== undefined
                            ? `${index + 1}.`
                            : '—';
                    const heading = document.createElement('p');
                    heading.className = 'team-results__team';
                    heading.textContent = `${placeLabel} ${team?.school || 'N/A'}`;
                    const score = document.createElement('p');
                    score.className = 'team-results__score';
                    score.textContent =
                        team?.eligible && team?.score !== null && team?.score !== undefined
                            ? `Score: ${team.score}`
                            : team?.status || 'Forfeit';
                    const detail = document.createElement('p');
                    detail.className = 'team-results__detail';
                    const placeList =
                        Array.isArray(team?.places) && team.places.length
                            ? `Places: ${team.places.join(', ')}`
                            : `Finishers: ${team?.finisher_count || 0}`;
                    const sixth = team?.sixth_runner ? ` • 6th: ${team.sixth_runner}` : '';
                    detail.textContent = `${placeList}${sixth}`;
                    li.append(heading, score, detail);
                    if (team?.tiebreak_note) {
                        const note = document.createElement('p');
                        note.className = 'team-results__note';
                        note.textContent = team.tiebreak_note;
                        li.appendChild(note);
                    }
                    fragment.appendChild(li);
                });
                teamResultsList.appendChild(fragment);
            };

            const toggleSimulateButton = (isLoading) => {
                if (!simulateButton) {
                    return;
                }
                simulateButton.disabled = isLoading;
                simulateButton.textContent = isLoading ? 'Working...' : 'Go';
            };

            const runSimulation = async () => {
                if (!simulateButton) {
                    return;
                }
                if (!selected.length) {
                    renderAthleteRows([]);
                    renderTeamScores([], sportSelect?.value);
                    setResultsMessage('Select at least one school to run the simulation.', {
                        type: 'error'
                    });
                    return;
                }
                const payload = {
                    schools: [...selected],
                    sport: sportSelect?.value,
                    event: eventSelect?.value,
                    gender: genderSelect?.value
                };
                toggleSimulateButton(true);
                setResultsMessage('Calculating results...');
                try {
                    const response = await fetch('/api/simulate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data?.error || 'Unable to simulate results.');
                    }
                    renderAthleteRows(data?.athletes || []);
                    renderTeamScores(data?.team_scores || [], data?.sport);
                    const summary = [];
                    if (data?.finishers) {
                        summary.push(`Calculated from ${data.finishers} eligible finishers.`);
                    }
                    if (Array.isArray(data?.athletes) && data.athletes.length) {
                        summary.push(`Showing ${data.athletes.length} athletes.`);
                    }
                    if (data?.message) {
                        summary.push(data.message);
                    }
                    if (Array.isArray(data?.missing_schools) && data.missing_schools.length) {
                        summary.push(`No eligible entries for: ${data.missing_schools.join(', ')}.`);
                    }
                    if (!summary.length) {
                        summary.push('Results updated.');
                    }
                    setResultsMessage(summary.join(' '));
                } catch (error) {
                    console.error('Simulation error', error);
                    renderAthleteRows([]);
                    renderTeamScores([], sportSelect?.value);
                    setResultsMessage(error?.message || 'Unable to simulate results.', {
                        type: 'error'
                    });
                } finally {
                    toggleSimulateButton(false);
                }
            };

            const updateDropdownDisplay = (selectEl, displayEl) => {
                if (!selectEl || !displayEl) {
                    return;
                }
                const option = selectEl.selectedOptions[0];
                displayEl.textContent = option ? option.textContent : 'Select option';
            };

            populateSelect(sportSelect, SPORTS);
            populateSelect(eventSelect, EVENTS);
            populateSelect(genderSelect, GENDERS);
            updateDropdownDisplay(sportSelect, sportDisplay);
            updateDropdownDisplay(eventSelect, eventDisplay);
            updateDropdownDisplay(genderSelect, genderDisplay);
            setResultsMessage(
                resultsMessage?.textContent?.trim() ||
                    'Select schools, configure filters, then press Go to simulate your meet.'
            );

            sportSelect?.addEventListener('change', () => {
                updateDropdownDisplay(sportSelect, sportDisplay);
                if (sportSelect?.value !== 'CROSS_COUNTRY') {
                    renderTeamScores([], sportSelect?.value);
                }
            });
            eventSelect?.addEventListener('change', () =>
                updateDropdownDisplay(eventSelect, eventDisplay)
            );
            genderSelect?.addEventListener('change', () =>
                updateDropdownDisplay(genderSelect, genderDisplay)
            );
            simulateButton?.addEventListener('click', runSimulation);

            searchInput.addEventListener('input', () => {
                const value = searchInput.value;
                if (!value.trim()) {
                    renderResults([], 'Start typing to search for a school.');
                    return;
                }
                const matches = getMatches(value);
                renderResults(matches, 'No schools match your search. Try another name.');
            });

            resultsList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-school-name]');
                if (!button) {
                    return;
                }
                addSchool(button.dataset.schoolName);
            });

            selectedList.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-remove-school]');
                if (!button) {
                    return;
                }
                removeSchool(button.dataset.removeSchool);
            });

            searchInput.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter') {
                    return;
                }
                const firstOption = resultsList.querySelector('button[data-school-name]');
                if (firstOption) {
                    addSchool(firstOption.dataset.schoolName);
                }
            });

            renderResults([], 'Loading school list...');
            renderSelected();
            loadSchools();
        })();
    </script>
</body>
</html>
